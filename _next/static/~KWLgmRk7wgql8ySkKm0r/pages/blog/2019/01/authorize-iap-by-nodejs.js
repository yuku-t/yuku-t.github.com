(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{1:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var t=n(19);Object.defineProperty(a,"MDXTag",{enumerable:!0,get:function(){return p(t).default}});var o=n(7);function p(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(a,"MDXProvider",{enumerable:!0,get:function(){return p(o).default}})},19:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var t,o=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var n=arguments[a];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},p=function(){function e(e,a){for(var n=0;n<a.length;n++){var t=a[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(a,n,t){return n&&e(a.prototype,n),t&&e(a,t),a}}(),c=n(0),s=(t=c)&&t.__esModule?t:{default:t},m=n(7);var r={inlineCode:"code",wrapper:"div"},l=function(e){function a(){return function(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}(this,a),function(e,a){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!a||"object"!=typeof a&&"function"!=typeof a?e:a}(this,(a.__proto__||Object.getPrototypeOf(a)).apply(this,arguments))}return function(e,a){if("function"!=typeof a&&null!==a)throw new TypeError("Super expression must either be null or a function, not "+typeof a);e.prototype=Object.create(a&&a.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),a&&(Object.setPrototypeOf?Object.setPrototypeOf(e,a):e.__proto__=a)}(a,c.Component),p(a,[{key:"render",value:function(){var e=this.props,a=e.name,n=e.parentName,t=e.props,p=void 0===t?{}:t,c=e.children,m=e.components,l=void 0===m?{}:m,u=e.Layout,i=e.layoutProps,N=l[n+"."+a]||l[a]||r[a]||a;return u?s.default.createElement(u,o({components:l},i),s.default.createElement(N,p,c)):s.default.createElement(N,p,c)}}]),a}();a.default=(0,m.withMDXComponents)(l)},377:function(e,a,n){__NEXT_REGISTER_PAGE("/blog/2019/01/authorize-iap-by-nodejs",function(){return e.exports=n(405),{page:e.exports.default}})},405:function(e,a,n){"use strict";n.r(a);var t=n(3),o=n.n(t),p=n(0),c=n.n(p),s=n(9),m=n(1);function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,a){if(null==e)return{};var n,t,o=function(e,a){if(null==e)return{};var n,t,o={},p=Object.keys(e);for(t=0;t<p.length;t++)n=p[t],a.indexOf(n)>=0||(o[n]=e[n]);return o}(e,a);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(t=0;t<p.length;t++)n=p[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function u(e,a){for(var n=0;n<a.length;n++){var t=a[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function i(e,a){return!a||"object"!==r(a)&&"function"!=typeof a?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):a}function N(e){return(N=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,a){return(g=Object.setPrototypeOf||function(e,a){return e.__proto__=a,e})(e,a)}var d=function(e){function a(e){var n;return function(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}(this,a),(n=i(this,N(a).call(this,e))).layout=null,n}var n,t,o;return function(e,a){if("function"!=typeof a&&null!==a)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(a&&a.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),a&&g(e,a)}(a,c.a.Component),n=a,(t=[{key:"render",value:function(){var e=this.props,a=e.components;l(e,["components"]);return c.a.createElement(m.MDXTag,{name:"wrapper",components:a},c.a.createElement(m.MDXTag,{name:"p",components:a},c.a.createElement(m.MDXTag,{name:"a",components:a,parentName:"p",props:{href:"https://cloud.google.com/iap/docs/authentication-howto#authenticating_from_a_service_account"}},"Google の公式ドキュメント"),"で Node.js での実装方法が紹介されていないこともあって、Cloud IAP で保護された GAE リソースに対し Node.js からアクセスするのにとても大変でした。"),c.a.createElement(m.MDXTag,{name:"p",components:a},"結論としては",c.a.createElement(m.MDXTag,{name:"a",components:a,parentName:"p",props:{href:"https://github.com/googleapis/google-auth-library-nodejs/blob/master/samples/iap.js"}},"このサンプル"),"の通りやればそれで万事 OK なのだけど、そこにいきつくまでの過程で分かったことを含めて記録として残します。"),c.a.createElement(m.MDXTag,{name:"h2",components:a},"Cloud IAP とは"),c.a.createElement(m.MDXTag,{name:"p",components:a},c.a.createElement(m.MDXTag,{name:"a",components:a,parentName:"p",props:{href:"https://cloud.google.com/iap/"}},"Cloud Identity-Aware Proxy")," （Cloud IAP）は Google Cloud Platform のサービスの一つで、 GCP 上のリソースに対する認証機能を提供します。"),c.a.createElement(m.MDXTag,{name:"p",components:a},"簡単な話が Cloud IAP の後ろにいるアプリには認証を通ったリクエストだけが到達するので、自分で認証機能を実装しなくていいので楽ができたり、自分で実装しない分安全性を担保しやすかったりします。"),c.a.createElement(m.MDXTag,{name:"p",components:a},"具体的には Cloud IAP を使うと特定の G Suite アカウントに紐付いたユーザーだけを認可する、というようなことができます。なので社内向けシステムを作ったりするときとか便利だったりします。"),c.a.createElement(m.MDXTag,{name:"h2",components:a},"認証に必要な情報"),c.a.createElement(m.MDXTag,{name:"p",components:a},"プログラムから認証するには以下の 3 つの情報が必要です:"),c.a.createElement(m.MDXTag,{name:"ul",components:a},c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},"Cloud IAP の OAuth2 認証のクライアント ID"),c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},"サービスアカウントのメールアドレス"),c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},"サービスアカウントのプライベートキー")),c.a.createElement(m.MDXTag,{name:"p",components:a},"これらを渡せば Google Cloud Platform は次のことを確認できることが直感的に分かります:"),c.a.createElement(m.MDXTag,{name:"ul",components:a},c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},"何に対してアクセスしようとしているのか"),c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},"誰がアクセスしてきていて、それは本人なのか"),c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},"そいつはアクセス権限を持っているのか")),c.a.createElement(m.MDXTag,{name:"p",components:a},"また事前にサービスアカウントに権限を設定しておく必要があることも明らかでしょう。"),c.a.createElement(m.MDXTag,{name:"h3",components:a},"具体的な操作"),c.a.createElement(m.MDXTag,{name:"p",components:a},"まずサービスアカウントを作り、 Cloud IAP のアクセスリストに追加します。具体的には Cloud Console の Identity-Aware Proxy からサービスアカウントを IAP-secured Web App User に追加しました。このユーザアカウントではないけど、他に適切そうなものが見当たらないので...。"),c.a.createElement(m.MDXTag,{name:"blockquote",components:a},c.a.createElement(m.MDXTag,{name:"ul",components:a,parentName:"blockquote"},c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},"Cloud IAP の OAuth2 認証のクライアント ID"))),c.a.createElement(m.MDXTag,{name:"p",components:a},"公式ドキュメントでは「画面を表示してメモしておく」というふわっとしたやり方で取得するよう言及されていますが、画面上部の「JSON ダウンロード」で JSON ファイルとしてダウンロードしてもいいかも知れません。"),c.a.createElement(m.MDXTag,{name:"blockquote",components:a},c.a.createElement(m.MDXTag,{name:"ul",components:a,parentName:"blockquote"},c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},"サービスアカウントのメールアドレス"),c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},"サービスアカウントのプライベートキー"))),c.a.createElement(m.MDXTag,{name:"p",components:a},"サービスアカウントの画面でキーを発行するとダウンロードできる JSON ファイルの中に含まれています。メールアドレスはどうでもいいのですが、プライベートキーは絶対に外部にもらしてはならないものなので git コミットしないようにする必要があります。"),c.a.createElement(m.MDXTag,{name:"h2",components:a},"Node.js から認証する"),c.a.createElement(m.MDXTag,{name:"p",components:a},"ここまではプログラミング言語によらず必要な処理です。用意した情報を用いて Node.js で認証するには ",c.a.createElement(m.MDXTag,{name:"a",components:a,parentName:"p",props:{href:"https://npmjs.com/package/google-auth-library"}},"google-auth-library")," を使うのが簡単です。"),c.a.createElement(m.MDXTag,{name:"p",components:a},"google-auth-library は環境情報から自動的にクライアントを用意してくれる機能があってそれを使うのが一般的と書かれているのですが、今回の場合 Cloud IAP のドキュメントで"),c.a.createElement(m.MDXTag,{name:"blockquote",components:a},c.a.createElement(m.MDXTag,{name:"p",components:a,parentName:"blockquote"},"クライアント ID を必要とする ",c.a.createElement(m.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"target_audience")," 追加要求を使用します")),c.a.createElement(m.MDXTag,{name:"p",components:a},"と書かれている部分を行わなければならない都合上 ",c.a.createElement(m.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"JWT")," インスタンスを直接作ります。"),c.a.createElement(m.MDXTag,{name:"pre",components:a,props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"JWT")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token function"}},"require"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token string"}},'"google-auth-library"'),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," client ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"new")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token class-name"}},"JWT"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{"),"\n  email",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},":")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"SERVICE_ACCOUNT_EMAIL"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},","),"\n  key",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},":")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"SERVICE_ACCOUNT_PRIVATE_KEY"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},","),"\n  additionalClaims",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},":")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{"),"\n    target_audience",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},":")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"OAUTH2CLIENT_ID"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},","),"\n  ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},","),"\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n")),c.a.createElement(m.MDXTag,{name:"p",components:a},"この ",c.a.createElement(m.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"client")," は Cloud IAP の認証を通るために必要な情報をすべて持っていることが分かります。 ",c.a.createElement(m.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"SERVICE_ACCOUNT_EMAIL")," と ",c.a.createElement(m.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"SERVICE_ACCOUNT_PRIVATE_KEY")," はダウンロードした JSON から作ります。"),c.a.createElement(m.MDXTag,{name:"p",components:a},"リソースにアクセスするにはアクセストークンを取得し ",c.a.createElement(m.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"Authorization")," ヘッダーを組み立てますが、 ",c.a.createElement(m.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"getRequestHeaders()")," という便利メソッドがあるのでそれを使うと楽です。 Cloud IAP の場合、アクセスするリソースの URL を引数で指定する必要がある点に注意が必要です。"),c.a.createElement(m.MDXTag,{name:"pre",components:a,props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," url ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token string"}},'"http://example.appspot.com/path/to/endpoint"'),"\n\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token comment"}},"// { Authorization: 'Bearer <access_token_value>' }"),"\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," headers ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"await")," client",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token method function property-access"}},"getRequestHeaders"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),"url",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n")),c.a.createElement(m.MDXTag,{name:"p",components:a},"このような形をしたオブジェクトを返してくれるので、このオブジェクトをクライアントライブラリに渡せば認証することができます。例えば ",c.a.createElement(m.MDXTag,{name:"a",components:a,parentName:"p",props:{href:"https://npmjs.com/package/axios"}},"axios")," を使っているならこんな具合です。"),c.a.createElement(m.MDXTag,{name:"pre",components:a,props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," axios ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token function"}},"require"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token string"}},'"axios"'),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\naxios",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token method function property-access"}},"request"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{")," url",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},",")," headers ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n")),c.a.createElement(m.MDXTag,{name:"p",components:a},"ただこのような操作はよくあるので、こんな感じで簡単にリクエストを送信できるようになっています。内部では axios と互換性のある gaxios というライブラリが使われています。"),c.a.createElement(m.MDXTag,{name:"pre",components:a,props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token comment"}},"// ↑の axios の呼び出しとほぼ同じ"),"\nclient",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token method function property-access"}},"request"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{")," url ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n")),c.a.createElement(m.MDXTag,{name:"p",components:a},"以上をまとめるとこんな感じで Node.js から Cloud IAP で保護されたリソースにアクセスすることができます。"),c.a.createElement(m.MDXTag,{name:"pre",components:a,props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-js"}},c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"JWT")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token function"}},"require"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token string"}},'"google-auth-library"'),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"OAUTH2_CLIENT_ID")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token string"}},'"..."'),"\n\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token comment"}},"// ダウンロードした　JSON ファイル"),"\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," credentials ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token function"}},"require"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token string"}},'"./service-account-credentials.json"'),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"SERVICE_ACCOUNT_EMAIL")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," credentials",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token property-access"}},"client_email"),"\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"SERVICE_ACCOUNT_PRIVATE_KEY")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," credentials",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token property-access"}},"private_key"),"\n\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"async")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"function")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token function"}},"main"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{"),"\n  ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," client ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"new")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token class-name"}},"JWT"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{"),"\n    email",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},":")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"SERVICE_ACCOUNT_EMAIL"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},","),"\n    key",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},":")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"SERVICE_ACCOUNT_PRIVATE_KEY"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},","),"\n    additionalClaims",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},":")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{"),"\n      target_audience",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},":")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token constant"}},"OAUTH2_CLIENT_ID"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},","),"\n    ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},","),"\n  ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n  ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," url ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token string"}},'"http://example.appspot.com"'),"\n  ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"const")," result ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token operator"}},"=")," ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token keyword"}},"await")," client",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token method function property-access"}},"request"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"{")," url ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n  ",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token console class-name"}},"console"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token method function property-access"}},"log"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),"result",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token property-access"}},"data"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"}"),"\n\n",c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token function"}},"main"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token method function property-access"}},"catch"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"("),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token console class-name"}},"console"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},"."),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token property-access"}},"error"),c.a.createElement(m.MDXTag,{name:"span",components:a,parentName:"code",props:{className:"token punctuation"}},")"),"\n")),c.a.createElement(m.MDXTag,{name:"h2",components:a},"参考"),c.a.createElement(m.MDXTag,{name:"ul",components:a},c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},c.a.createElement(m.MDXTag,{name:"a",components:a,parentName:"li",props:{href:"https://cloud.google.com/iap/docs/authentication-howto#authenticating_from_a_service_account"}},"プログラムによる認証  |  Identity-Aware Proxy のドキュメント  |  Google Cloud")),c.a.createElement(m.MDXTag,{name:"li",components:a,parentName:"ul"},c.a.createElement(m.MDXTag,{name:"a",components:a,parentName:"li",props:{href:"https://github.com/googleapis/google-auth-library-nodejs/blob/master/samples/iap.js"}},"google-auth-library-nodejs/iap.js at master · googleapis/google-auth-library-nodejs"))))}}])&&u(n.prototype,t),o&&u(n,o),a}();function E(e){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function T(e,a,n,t,o,p,c){try{var s=e[p](c),m=s.value}catch(e){return void n(e)}s.done?a(m):Promise.resolve(m).then(t,o)}function M(e,a){for(var n=0;n<a.length;n++){var t=a[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function D(e,a){return!a||"object"!==E(a)&&"function"!=typeof a?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):a}function X(e){return(X=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,a){return(f=Object.setPrototypeOf||function(e,a){return e.__proto__=a,e})(e,a)}n.d(a,"default",function(){return k});var k=function(e){function a(){return function(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}(this,a),D(this,X(a).apply(this,arguments))}var t,p,m;return function(e,a){if("function"!=typeof a&&null!==a)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(a&&a.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),a&&f(e,a)}(a,c.a.Component),t=a,p=[{key:"render",value:function(){return c.a.createElement(s.a,{meta:this.props.meta},c.a.createElement(d,null))}}],m=[{key:"getInitialProps",value:function(){var e,a=(e=o.a.mark(function e(){var a,t;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=n(25),t=a.entries,e.abrupt("return",{meta:t["blog/2019/01/authorize-iap-by-nodejs"]});case 2:case"end":return e.stop()}},e)}),function(){var a=this,n=arguments;return new Promise(function(t,o){var p=e.apply(a,n);function c(e){T(p,t,o,c,s,"next",e)}function s(e){T(p,t,o,c,s,"throw",e)}c(void 0)})});return function(){return a.apply(this,arguments)}}()}],p&&M(t.prototype,p),m&&M(t,m),a}()},7:function(e,a,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.withMDXComponents=void 0;var t,o=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var n=arguments[a];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},p=n(0),c=(t=p)&&t.__esModule?t:{default:t};var s=c.default.createContext({}),m=s.Provider,r=s.Consumer;a.withMDXComponents=function(e){return function(a){var n=a.components,t=function(e,a){var n={};for(var t in e)a.indexOf(t)>=0||Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n}(a,["components"]);return c.default.createElement(r,null,function(a){return c.default.createElement(e,o({components:n||a},t))})}};a.default=function(e){var a=e.components,n=e.children;return c.default.createElement(m,{value:a},n)}}},[[377,1,0,2]]]);