// Generate src/entries.js

const util = require("util")
const fs = require("fs")
const path = require("path")

const glob = require("glob")
const moment = require("moment")

const readFileAsync = util.promisify(fs.readFile)

function extractTitle(content) {
  return /title: ("[^"]+")(,|\n)/.exec(content)[1]
}

function extractPublishedAt(content) {
  return /publishedAt: "([^"]+)"(,|\n)/.exec(content)[1]
}

function extractTags(content) {
  return /tags: (\[[^\]]+\])/.exec(content)[1]
}

function extractHref(string) {
  return path.join(path.dirname(string.substr("pages/".length)), path.basename(string, ".mdx"))
}

async function extractMeta(mdxFilepath) {
  const content = await readFileAsync(mdxFilepath)
  console.log(`Processing: ${mdxFilepath}`)
  const publishedAt = extractPublishedAt(content)
  return {
    href: extractHref(mdxFilepath),
    moment: moment(publishedAt),
    publishedAt,
    title: extractTitle(content),
    tags: extractTags(content),
  }
}

function printEntry(entry) {
  return `{
    href: "${entry.href}",
    publishedAt: moment("${entry.publishedAt}"),
    tags: ${entry.tags},
    title: ${entry.title},
  }`
}

async function writeEntries(entries) {
  fs.writeFileSync(
    "src/entries.ts",
    `// Auto generated by script/extract-metadata
    import moment from "moment"
    export default [${entries.map(printEntry).join(",")}]
  `,
  )
  console.log("Generated: src/entries.ts")
}

async function main() {
  const mdxFilepaths = glob.sync("pages/blog/**/*.mdx")
  const entries = await Promise.all(mdxFilepaths.map(extractMeta))
  await writeEntries(entries.sort((a, b) => b.moment - a.moment))
}

main()
